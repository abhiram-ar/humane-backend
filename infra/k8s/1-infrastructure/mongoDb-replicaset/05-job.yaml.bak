# k8s/mongo-init.yaml - Simplest approach
apiVersion: batch/v1
kind: Job
metadata:
  name: mongo-init
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-mongo
          image: busybox:1.35
          command:
            - "sh"
            - "-c"
            - |
              echo "Waiting for MongoDB pods to be ready..."
              until nc -z mongo-0.mongo 27017; do echo "Waiting for mongo-0..."; sleep 5; done
              until nc -z mongo-1.mongo 27017; do echo "Waiting for mongo-1..."; sleep 5; done  
              until nc -z mongo-2.mongo 27017; do echo "Waiting for mongo-2..."; sleep 5; done
              echo "All MongoDB pods are ready!"
      containers:
        - name: mongo-init
          image: mongo:7
          command:
            - "bash"
            - "-c"
            - |
              echo "Starting replica set initialization..."

              # Create a JavaScript file for the replica set configuration
              cat > /tmp/init-replica.js << 'EOF'
              try {
                var status = rs.status();
                print("Replica set already initialized with status: " + status.ok);
              } catch (e) {
                if (e.message.includes("no replset config")) {
                  print("Initializing replica set...");
                  var config = {
                    _id: "rs0",
                    members: [
                      { _id: 0, host: "mongo-0.mongo:27017" },
                      { _id: 1, host: "mongo-1.mongo:27017" },
                      { _id: 2, host: "mongo-2.mongo:27017" }
                    ]
                  };
                  var result = rs.initiate(config);
                  print("Replica set initialization result:");
                  printjson(result);
                } else {
                  print("Unexpected error: " + e.message);
                  throw e;
                }
              }
              EOF

              # Execute the replica set initialization
              mongosh --host mongo-0.mongo:27017 --file /tmp/init-replica.js
      restartPolicy: OnFailure
